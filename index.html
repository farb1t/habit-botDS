<!-- index.html (–∫–ª–∏–µ–Ω—Ç: –æ–¥–∏–Ω —Ñ–∞–π–ª, –ø—Ä–æ—Å—Ç–æ–π —á–∞—Ç —Å –ø–æ—Ç–æ–∫–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π) -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Habit Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1020; --card:#111936; --ink:#e9ecf1; --muted:#a9b4cc; --accent:#5aa9ff; }
    html,body { margin:0; padding:0; height:100%; background:var(--bg); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;}
    .wrap { max-width: 840px; margin: 0 auto; padding: 16px; height: 100%; display: grid; grid-template-rows: auto 1fr auto; gap: 12px; }
    header { display:flex; align-items:center; gap:10px; }
    header h1 { font-size: 18px; margin:0; }
    #log { background: var(--card); border-radius: 14px; padding: 12px; overflow-y: auto; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    .msg { display:flex; gap:10px; padding: 10px 8px; }
    .msg.user { justify-content:flex-end; }
    .msg .bubble { max-width: 70%; padding: 10px 12px; border-radius: 12px; line-height: 1.45; white-space: pre-wrap; word-wrap: break-word; }
    .msg.user .bubble { background: #1d2b5a; }
    .msg.assistant .bubble { background: #0f254d; }
    .role { font-size: 11px; color: var(--muted); margin: 0 0 4px 2px; }
    form { display:flex; gap:10px; }
    textarea { flex:1; resize: none; min-height: 56px; max-height: 160px; padding: 12px; border-radius: 12px; border:1px solid #243257; background:#0d1734; color:var(--ink); outline:none; }
    button { background: var(--accent); color:#051126; border:none; padding: 0 16px; border-radius: 12px; font-weight: 600; cursor: pointer; }
    button[disabled]{ opacity:.6; cursor: not-allowed; }
    .hint { color: var(--muted); font-size: 12px; }
    .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,.35); border-top-color: #fff; border-radius: 50%; display:inline-block; animation: spin .8s linear infinite; vertical-align: -2px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    a { color: #a7d0ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M5 12h14M12 5v14" stroke="#5aa9ff" stroke-width="2" stroke-linecap="round"/></svg>
      <h1>Habit Chat ¬∑ Mistral</h1>
    </header>

    <div id="log" aria-live="polite"></div>

    <form id="composer">
      <textarea id="input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶ (–∫–∞–∂–¥–æ–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ API)"></textarea>
      <button id="send" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
    <div class="hint">–ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Ö–æ–¥–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏. –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç –≤—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –±—ç–∫–µ.</div>
  </div>

  <script>
    // –ë—ç–∫ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω –Ω–∞ —Ç–æ–º –∂–µ –¥–æ–º–µ–Ω–µ/–ø–æ–¥–¥–æ–º–µ–Ω–µ (workers.dev –∏–ª–∏ –≤–∞—à–µ–π –ø—Ä–∏–≤—è–∑–∫–µ)
    const API_BASE = ""; // –ø—É—Å—Ç–æ = —Ç–µ–∫—É—â–∏–π origin. –ò—Ç–æ–≥–æ POST –Ω–∞ /chat/stream

    const logEl = document.getElementById("log");
    const form = document.getElementById("composer");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");

    // –ü–∞–º—è—Ç—å —á–∞—Ç–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ü–µ–ª–∏–∫–æ–º –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
    const history = []; // [{role:"user"|"assistant", content:"..."}]

    function addMessage(role, content, temporary=false) {
      const msg = document.createElement("div");
      msg.className = `msg ${role}`;
      msg.innerHTML = `
        <div class="bubble">
          <div class="role">${role === "user" ? "–í—ã" : "–ü–æ–º–æ—â–Ω–∏–∫"}</div>
          <div class="content">${escapeHtml(content)}</div>
        </div>
      `;
      if (temporary) msg.dataset.temp = "1";
      logEl.appendChild(msg);
      scrollToBottom();
      return msg.querySelector(".content");
    }

    function updateLastAssistantContent(text) {
      const nodes = [...logEl.querySelectorAll('.msg.assistant .content')];
      for (let i = nodes.length - 1; i >= 0; i--) {
        const parent = nodes[i].closest('.msg.assistant');
        if (parent && parent.dataset.temp === "1") {
          nodes[i].textContent = text;
          break;
        }
      }
      scrollToBottom();
    }

    function finalizeTempAssistant() {
      const temp = logEl.querySelectorAll('.msg.assistant[data-temp="1"]');
      temp.forEach(el => el.removeAttribute('data-temp'));
    }

    function setBusy(busy) {
      input.disabled = busy;
      sendBtn.disabled = busy;
      sendBtn.innerHTML = busy ? '<span class="spinner"></span>' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
    }

    function scrollToBottom() {
      logEl.scrollTop = logEl.scrollHeight;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    async function sendMessage(text) {
      const userText = text.trim();
      if (!userText) return;

      // –î–æ–±–∞–≤–ª—è–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —é–∑–µ—Ä-—Å–æ–æ–±—â–µ–Ω–∏–µ
      history.push({ role: "user", content: userText });
      addMessage("user", userText);

      // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—Ä–µ–º–æ–≤–æ–≥–æ —É–∑–ª–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
      const assistantNode = addMessage("assistant", "", true);
      setBusy(true);

      // –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–µ–∑–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é (–±–µ–∑ system ‚Äî —Å–µ—Ä–≤–µ—Ä –¥–æ–±–∞–≤–∏—Ç —Å–∞–º)
      const payload = { messages: history };

      try {
        // –ü–æ—Ç–æ–∫–æ–≤—ã–π –≤—ã–∑–æ–≤
        const resp = await fetch(API_BASE + "/chat/stream", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!resp.ok || !resp.body) {
          throw new Error("Bad response from server");
        }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let buffer = "";
        let assistantText = "";

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });

          // –†–∞–∑–±–∏—Ä–∞–µ–º SSE —á–∞–Ω–∫–∏
          const parts = buffer.split("\n\n");
          buffer = parts.pop() || "";

          for (const part of parts) {
            const lines = part.split("\n");
            for (const line of lines) {
              if (!line.startsWith("data:")) continue;
              const data = line.slice(5).trim();
              if (!data || data === "[DONE]") continue;

              let json;
              try { json = JSON.parse(data); } catch { continue; }

              // –§–æ—Ä–º–∞—Ç Mistral SSE: { choices: [{ delta: { content: "..." } }] }
              const delta = json?.choices?.[0]?.delta?.content ?? "";
              if (delta) {
                assistantText += delta;
                updateLastAssistantContent(assistantText);
              }
            }
          }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        finalizeTempAssistant();
        if (assistantText.trim().length === 0) {
          assistantText = "(–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç)";
          updateLastAssistantContent(assistantText);
        }
        history.push({ role: "assistant", content: assistantText });
      } catch (err) {
        updateLastAssistantContent("–û—à–∏–±–∫–∞: " + (err?.message || String(err)));
        finalizeTempAssistant();
        history.push({ role: "assistant", content: "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º." });
      } finally {
        setBusy(false);
      }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = input.value;
      input.value = "";
      sendMessage(text);
    });

    // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Äî –µ–¥–∏–Ω–∏—á–Ω–æ–µ —Å–ª–æ–≤–æ, —á—Ç–æ–±—ã –º–æ–¥–µ–ª—å —Å–∞–º–∞ –∑–∞–¥–∞–ª–∞ 3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞
    (function greet() {
      addMessage("assistant", "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≤—ã—á–∫—É. –ù–∞–ø–∏—à–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å¬ª, —á—Ç–æ–±—ã –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å.");
    })();
  </script>
</body>
</html>
