<!-- index.html — фронт (фикс: удаляем лишние * и повышаем max_tokens на клиенте) -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Habit Chat (Mistral + Workers)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#94a3b8; --accent:#22d3ee; }
    * { box-sizing: border-box; }
    body { margin:0; background:linear-gradient(180deg,#0b1220,#0f172a); color:var(--text); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; display:flex; min-height:100vh; }
    .wrap { margin:auto; width:min(900px,100%); padding:24px; }
    .card { background:rgba(17,24,39,.75); backdrop-filter: blur(6px); border:1px solid rgba(148,163,184,.15); border-radius:16px; overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    header { padding:16px 20px; border-bottom:1px solid rgba(148,163,184,.15); display:flex; align-items:center; gap:12px; }
    header .dot { width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 8px var(--accent); }
    header h1 { font-size:16px; margin:0; font-weight:600; letter-spacing:.3px; }
    #log { height:60vh; overflow:auto; padding:20px; display:flex; flex-direction:column; gap:14px; scroll-behavior:smooth; }
    .msg { max-width:80%; padding:12px 14px; border-radius:14px; white-space:pre-wrap; word-wrap:break-word; }
    .me { align-self:flex-end; background:#1f2937; border:1px solid rgba(148,163,184,.2); }
    .ai { align-self:flex-start; background:#0b1325; border:1px solid rgba(34,211,238,.25); }
    .muted { color:var(--muted); font-size:12px; }
    form { display:flex; gap:10px; padding:14px; border-top:1px solid rgba(148,163,184,.15); background:#0b1220; }
    textarea { flex:1; resize:none; max-height:160px; min-height:48px; padding:12px; border-radius:12px; border:1px solid rgba(148,163,184,.25); background:#0a0f1c; color:var(--text); }
    button { padding:12px 16px; border-radius:12px; border:1px solid rgba(148,163,184,.25); background:linear-gradient(180deg,#0ea5b7,#0891a5); color:white; font-weight:600; cursor:pointer; }
    .row { display:flex; align-items:center; gap:10px; padding:0 14px 12px; color:var(--muted); }
    .row label { display:flex; align-items:center; gap:6px; cursor:pointer; }
    .pill { font-size:12px; padding:4px 8px; border:1px solid rgba(148,163,184,.25); border-radius:999px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div class="dot"></div>
        <h1>Помощник привычек · Mistral</h1>
        <span class="pill" id="mode-pill">SSE</span>
      </header>

      <div id="log" aria-live="polite"></div>

      <div class="row">
        <label><input type="checkbox" id="stream" checked> Поток (SSE)</label>
        <span style="font-size:12px;color:var(--muted)">Каждое сообщение уходит в API, ответ всегда отображается в чате</span>
      </div>

      <form id="form">
        <textarea id="input" placeholder="Напишите сообщение… (например: «Начать»)" required></textarea>
        <button type="submit">Отправить</button>
      </form>
    </div>
  </div>

  <script>
    // ======= НАСТРОЙКИ =======
    const WORKER_BASE = location.origin.includes("workers.dev") || location.host.endsWith(".workers.dev")
      ? location.origin
      : "https://YOUR-WORKER-NAME.workers.dev";
    const CHAT_URL = WORKER_BASE + "/chat";
    const STREAM_URL = WORKER_BASE + "/chat/stream";

    const log = document.getElementById("log");
    const form = document.getElementById("form");
    const input = document.getElementById("input");
    const streamToggle = document.getElementById("stream");
    const modePill = document.getElementById("mode-pill");

    const history = [];

    // ——— Удаляем лишние звездочки и markdown (жирный/курсив/инлайн-код) ———
    function cleanMarkdown(text) {
      if (!text) return "";
      // убираем **bold**
      text = text.replace(/\*\*(.*?)\*\*/g, "$1");
      // убираем *italic*
      text = text.replace(/(^|[\s(])\*(.*?)\*([\s).,!?:;]|$)/g, "$1$2$3");
      // слотные одинокие звёздочки
      text = text.replace(/\*/g, "");
      // инлайн-код `...`
      text = text.replace(/`([^`]+)`/g, "$1");
      // многоточия и двойные пробелы нормализуем
      return text.replace(/[ \t]+/g, " ").replace(/\n{3,}/g, "\n\n").trim();
    }

    function addMsg(role, content) {
      const div = document.createElement("div");
      div.className = "msg " + (role === "user" ? "me" : "ai");
      div.textContent = content;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    streamToggle.addEventListener("change", () => {
      modePill.textContent = streamToggle.checked ? "SSE" : "JSON";
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      history.push({ role: "user", content: text });
      addMsg("user", text);
      input.value = "";

      if (streamToggle.checked) {
        await sendStream();
      } else {
        await sendJSON();
      }
    });

    async function sendJSON() {
      const body = {
        messages: history.slice(-50),
        temperature: 0.4,
        max_tokens: 3000  // больше токенов — меньше шансов на обрыв
      };

      const res = await fetch(CHAT_URL, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        const err = await res.text();
        addMsg("assistant", "Ошибка запроса: " + err);
        return;
      }

      const data = await res.json();
      const content = cleanMarkdown(data?.content || "");
      history.push({ role: "assistant", content });
      addMsg("assistant", content);
    }

    async function sendStream() {
      const body = {
        messages: history.slice(-50),
        temperature: 0.4,
        max_tokens: 3000
      };

      const res = await fetch(STREAM_URL, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(body),
      });

      if (!res.ok || !res.body) {
        const err = await res.text();
        addMsg("assistant", "Ошибка потока: " + err);
        return;
      }

      let acc = "";
      const reader = res.body.getReader();
      const decoder = new TextDecoder();

      const liveDiv = document.createElement("div");
      liveDiv.className = "msg ai";
      liveDiv.textContent = "…";
      log.appendChild(liveDiv);
      log.scrollTop = log.scrollHeight;

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });

        for (const line of chunk.split(/\r?\n/)) {
          if (!line.startsWith("data:")) continue;
          const dataPart = line.slice(5).trim();
          if (!dataPart || dataPart === "[DONE]") continue;
          try {
            const evt = JSON.parse(dataPart);
            const delta = evt?.choices?.[0]?.delta?.content ?? "";
            if (delta) {
              acc += delta;
              // показываем очищенный текст "на лету"
              liveDiv.textContent = cleanMarkdown(acc);
              log.scrollTop = log.scrollHeight;
            }
          } catch { /* пропускаем не-JSON */ }
        }
      }

      acc = cleanMarkdown(acc);
      history.push({ role: "assistant", content: acc });
    }
  </script>
</body>
</html>
